<%- include('head-foot/header'); -%>
<div class="main_box">

    <button id="my_orders" style="border: 0;">My orders</button>
    <input type="number" id="len" value="<%= orders.length %>" style="visibility: collapse;display: none;">
    <div id="cart_box_head" class="order_box_head">
        <p class="head_orders_margs">Date</p>
        <p class="head_orders_margs">Order Id</p>
        <p class="head_orders_margs" style="margin-right: 3.2552083333333335vw;">Total</p>
        <p class="head_orders_margs">Status</p>
        <p style="flex: 1;"></p>
    </div>


    <div class="order_box1">

        <div class="orders">

            <%for(var i=(orders.length-1);i>=0;i--){%>

            <div id="order_bf_click<%=i%>" class="order_bf_click">

                <span id="date<%= i%>" class="order_style"><%=orders[i].date%></span>

                <% if(typeof orders[i].order_id ==='undefined'){ %>
                <button class="order_style2" id="but<%=i%>" style="border: 0;">Random Id </button>
                <% } %>
                <% if(typeof orders[i].order_id!=='undefined'){ %>
                <button class="order_style2" id="but<%=i%>" style="border: 0;"><%= orders[i].order_id %> </button>

                <% } %>
                <span id="totalprice<%= i%>" class="order_style">₹<%=orders[i].total_price%></span>
                <span id="status<%= i%>" class="order_style1">status_bla</span>

            </div>

            <div id="order_info<%= i %>" style="display: none;">

                <a href="/shiprocket/<%= orders[i].order_id %>"><button id="cancelorder<%= i %>">Cancel all these
                        orders</button></a>
                <span id="orderid<%=i%>">order id:</span>
                <span id="add<%=i%>">Address : </span>
                <span id="city<%=i%>">city : </span>
                <span id="state<%=i%>">state : </span>
                <span id="pin<%=i%>">pincode : </span>
                <input type="text" id="date<%= i %>" value="<%=orders[i].date%>" style="display:none;">
                <% if(typeof orders[i].order_id ==='undefined'){ %>
                    <button class="order_style2" id="but<%=i%>" style="border: 0;">Random Id </button>
                    <% } %>
                    <% if(typeof orders[i].order_id!=='undefined'){ %>
                    <button class="order_style2" id="but<%=i%>" style="border: 0;"><%= orders[i].order_id %> </button>
    
                    <% } %>



                <% { %>
                <%var obj = track.find(o => o.order_id === orders[i].order_id+"_0")%>
                <% if(typeof obj!=='undefined'){ %>

                <% if(obj.shiprocket_order_info[0]==='<'){ %>
                <input type="text" name="" id="order_id<%=i%>" value="null" style="display:none;">
                <% } %>
                <% if(obj.shiprocket_order_info[0]!=='<'){ %>
                <input type="text" name="" id="order_id<%=i%>"
                    value="<%= JSON.parse(obj.shiprocket_order_info).order_id %>" style="display:none;">

                <% } %>

                <% } %>
                <% if(typeof obj==='undefined') {%>
                <input type="text" name="" id="order_id<%=i%>" value="null" style="display:none;">

                <% } %>
                <% } %>




                <% for(let j = 0;j<orders[i].items.length;++j){ %>
                <h3><%=orders[i].items[j].name%></h3>
                <span id="date<%=i %> " class="">Date: <%=orders[i].date%></span>
                <span id="" class="">Payment Method : <%=orders[i].items[j].payment_method%></span>
                <span id="status<%= i%>" class="order_style1">Status : status_bla</span>

                <img class="order_image" src="<%=orders[i].items[j].product_image%>"></img>
                <% { %>
                <% var obj = track.find(o => o.order_id === orders[i].order_id+"_"+j) %>
                <% if(obj){ %>

                <% if(obj.shiprocket_order_info[0]==='<'){ %>
                <p style="opacity: 0;visibility: collapse;"> shipment_id : N/A </p>
                <p style="opacity: 0;visibility: collapse;"> Shiprocket order id : N/A </p>
                <% } %>
                <% if(obj.shiprocket_order_info[0]!=='<'){ %>
                <p style="opacity: 0;visibility: collapse;">shipment_id :
                    <%= JSON.parse(obj.shiprocket_order_info).shipment_id %> </p>
                <p style="opacity: 0;visibility: collapse;">Shiprocket order id :
                    <%= JSON.parse(obj.shiprocket_order_info).order_id %></p>
                <% } %>
                <% } %>
                <%if(typeof obj==='undefined'){%>
                <p style="opacity: 0;visibility: collapse;"> shipment_id : N/A </p>
                <p style="opacity: 0;visibility: collapse;"> Shiprocket order id : N/A </p>
                <%}%>
                
          

            <% } %>






                <br>
                <br>
                <!-- <div class="order_box">
                <div class="order_flex">

                    <img class="order_image" src="<%=orders[i].items[j].product_image%>"></img>
                    <div class="ordeer_mid" style="flex:1;">
                        <h3><%=orders[i].items[j].name%></h3>
                    </div>
                    <div class="order_details">
                        <p style="margin-bottom: 0px;"><span style="font-weight:bolder;">Date:</span>
                            <%=orders[i].date%>
                        </p>
                        <p class="order_details_items" style="margin-bottom: 0;"><span style="font-weight:bolder;">Price
                                Paid:</span> ₹<%=orders[i].items[j].total_price%></p>
                        <p class="order_details_items" style="margin-bottom: 0;"><span
                                style="font-weight:bolder;">Original
                                Price:</span> ₹<%=orders[i].items[j].original_price%></p>
                        <p class="order_details_items" style="margin-bottom: 0;"><span
                                style="font-weight:bolder;">Quantity:</span> <%=orders[i].items[j].quantity%></p>

                        <%if(orders[i].items[j].coupon_code){%>
                        <p class="order_details_items" style="margin-bottom: 0;"><span
                                style="font-weight:bolder;">Coupon
                                Applied:</span> <span
                                style="text-transform:uppercase"><%=orders[i].items[j].coupon_code%></span></p>
                        <%}%>
                        <%if(orders[i].items[j].payment_method=="COD"){%>
                        <p class="order_details_items" style="margin-bottom: 0;"><span
                                style="font-weight:bolder;">Payment
                                Method:</span> <%=orders[i].items[j].payment_method%><br>
                            <span class="order_shipping_charge">(₹50 charged extra as shipping charges)</span></p>
                        <%}%>
                        <%if(orders[i].items[j].payment_method=="Paid Online"){%>
                        <p class="order_details_items" style="margin-bottom: 0;"><span
                                style="font-weight:bolder;">Payment
                                Method:</span> <%=orders[i].items[j].payment_method%></p>
                        <%}%>
                    </div>
        
                </div>
        
            </div> -->
                <% }%>

            </div>

            <%}%>
    </div>
    </div>
</div>
<%- include('head-foot/footer'); -%>






            <script>
                for (let i = 0; i < Number(document.getElementById('len').value); ++i) {


                    var observer = new MutationObserver(function (mutations) {
                        mutations.forEach(function (mutationRecord) {

                            if (document.getElementById('order_info' + i).style.display === "initial") {
                                var d = document.getElementById('date' + i).innerHTML
                                var p = d.split('-')
                                var date1 = new Date(p[1] + "/" + p[2] + "/" + p[0])
                                var today = new Date();
                                var dd = String(today.getDate()).padStart(2, '0');
                                var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
                                var yyyy = today.getFullYear();

                                today = dd + '/' + mm + '/' + yyyy;
                                var date2 = new Date(mm + '/' + dd + '/' + yyyy)

                                var Difference_In_Time = date2.getTime() - date1.getTime();
                                var diff = Difference_In_Time / (1000 * 3600 * 24);
                                if (diff > 2) {
                                    document.getElementById('cancelorder' + i).style.display = "none"
                                }

                            }
                            //         if(document.getElementById('order_info'+i).style.display!=="none"){

                            //             var d = document.getElementById('date'+i).value

                            //         }
                        });
                    });

                    var target = document.getElementById('order_info' + i);
                    observer.observe(target, {
                        attributes: true,
                        attributeFilter: ['style']
                    });




                    var id = document.getElementById('order_id' + i).value
                    if (id != "null") {


                        var myHeaders = new Headers();
                        myHeaders.append("Content-Type", "application/json");
                        myHeaders.append("Authorization",
                            "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjE2MzU2NjksImlzcyI6Imh0dHBzOi8vYXBpdjIuc2hpcHJvY2tldC5pbi92MS9leHRlcm5hbC9hdXRoL2xvZ2luIiwiaWF0IjoxNjI1OTQyMTIyLCJleHAiOjE2MjY4MDYxMjIsIm5iZiI6MTYyNTk0MjEyMiwianRpIjoienFvUEE2R0F5alRQSjJNMyJ9.oA3ea1cTIPxRBXxR4sZUwWFgRioyAO30OSJsNOe5S5M"
                            );

                        var requestOptions = {
                            method: 'GET',
                            headers: myHeaders,
                            redirect: 'follow'
                        };

                        fetch("https://apiv2.shiprocket.in/v1/external/orders/show/" + id, requestOptions)
                            .then(res => {
                                console.log(res.text().then(rs => {
                                    console.log(JSON.parse(rs).data)
                                    document.getElementById('add' + i).innerHTML = "Address :" + JSON
                                        .parse(rs).data.billing_address
                                    document.getElementById('city' + i).innerHTML = "City :" + JSON
                                        .parse(rs).data.billing_city
                                    document.getElementById('state' + i).innerHTML = "State :" + JSON
                                        .parse(rs).data.billing_state_name
                                    document.getElementById('pin' + i).innerHTML = "Pincode :" + JSON
                                        .parse(rs).data.billing_pincode


                                }))
                            })
                            .catch(error => console.log('error', error));

                    }
                }



                for (let i = 0; i < Number(document.getElementById('len').value); ++i) {

                    document.getElementById('but' + i).addEventListener('click', () => {
                        document.getElementById('order_info' + i).style.display = "initial"
                        document.getElementById("cart_box_head").style.display = "none"
                        document.getElementById('my_orders').innerHTML = "Back"



                        for (let j = 0; j < Number(document.getElementById('len').value); ++
                            j) {
                            document.getElementById('but' + j).style.display = "none"
                            document.getElementById("date" + j).style.display = "none"
                            document.getElementById("totalprice" + j).style.display = "none"
                            document.getElementById("order_bf_click"+j).style.visibility="collapse"
                            document.getElementById("status" + j).style.display = "none"
                        }



                    })
                }

                document.getElementById('my_orders').addEventListener("click", () => {
                    document.getElementById('my_orders').innerHTML = "My Orders"
                    document.getElementById("cart_box_head").style.display = "flex"

                    for (let i = 0; i < Number(document.getElementById('len').value); ++i) {
                        document.getElementById('order_info' + i).style.display = "none"
                        document.getElementById('but' + i).style.display = "initial"
                        document.getElementById("date" + i).style.display = "initial"
                        document.getElementById("totalprice" + i).style.display = "initial"
                        document.getElementById("status" + i).style.display = "initial"
                        document.getElementById("order_bf_click"+i).style.visibility="visible"



                    }
                })
            </script>